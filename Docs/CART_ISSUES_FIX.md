# è´­ç‰©è½¦é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

### é—®é¢˜1: é‡å¤æ·»åŠ äº§å“
æœ‰æ—¶å€™ç‚¹å‡»äº§å“ä¸Šçš„"Add to Cart"æŒ‰é’®ä¼šåŠ å…¥2ä¸ªäº§å“ï¼Œå¯¼è‡´è´­ç‰©è½¦æ•°é‡ä¸æ­£ç¡®ã€‚

### é—®é¢˜2: ç™»å½•åè´­ç‰©è½¦ä¸¢å¤±
ç”¨æˆ·ç™»å½•åï¼Œä¹‹å‰åœ¨è´­ç‰©è½¦ä¸­çš„äº§å“ä¼šä¸¢å¤±ï¼Œæ— æ³•çœ‹åˆ°ä¹‹å‰æ·»åŠ çš„å•†å“ã€‚

## é—®é¢˜åŸå› åˆ†æ

### é—®é¢˜1: é‡å¤æ·»åŠ äº§å“
- **åŸå› **: åœ¨`addItem`å‡½æ•°ä¸­ä½¿ç”¨äº†ä¹è§‚æ›´æ–°ï¼Œä½†æ²¡æœ‰æ­£ç¡®å¤„ç†é‡å¤ç‚¹å‡»çš„æƒ…å†µ
- **å½±å“**: ç”¨æˆ·å¿«é€Ÿç‚¹å‡»æ—¶å¯èƒ½è§¦å‘å¤šæ¬¡APIè¯·æ±‚ï¼Œå¯¼è‡´é‡å¤æ·»åŠ 

### é—®é¢˜2: ç™»å½•åè´­ç‰©è½¦ä¸¢å¤±
- **åŸå› **: ç™»å½•åˆå¹¶è´­ç‰©è½¦åï¼Œè´­ç‰©è½¦ä¸Šä¸‹æ–‡æ²¡æœ‰é‡æ–°åŠ è½½ç”¨æˆ·è´­ç‰©è½¦æ•°æ®
- **å½±å“**: ç”¨æˆ·ç™»å½•åçœ‹ä¸åˆ°ä¹‹å‰çš„è´­ç‰©è½¦å†…å®¹

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1: é˜²æ­¢é‡å¤æ·»åŠ äº§å“

#### ä¿®æ”¹å‰çš„é—®é¢˜ä»£ç 
```typescript
const addItem = async (product) => {
  // ä¹è§‚æ£€æŸ¥ï¼Œä½†æ²¡æœ‰é˜²æ­¢é‡å¤è¯·æ±‚
  const existingItem = state.items.find(item => item.productId === product.id);
  const quantity = (existingItem?.quantity || 0) + 1;
  
  // ç›´æ¥å‘é€æ·»åŠ è¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´é‡å¤
  const response = await fetch('/api/cart/items', {
    method: 'POST',
    body: JSON.stringify({
      productId: product.id,
      quantity: 1,
    }),
  });
};
```

#### ä¿®å¤åçš„ä»£ç 
```typescript
const addItem = async (product) => {
  // æ£€æŸ¥å•†å“æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
  const existingItem = state.items.find(item => item.productId === product.id);
  if (existingItem) {
    // å¦‚æœå•†å“å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°é‡è€Œä¸æ˜¯æ·»åŠ 
    await updateQuantity(existingItem.id, existingItem.quantity + 1);
    return;
  }

  // åªæœ‰æ–°å•†å“æ‰å‘é€æ·»åŠ è¯·æ±‚
  const response = await fetch('/api/cart/items', {
    method: 'POST',
    body: JSON.stringify({
      productId: product.id,
      quantity: 1,
    }),
  });
};
```

### ä¿®å¤2: ç™»å½•åè´­ç‰©è½¦æ•°æ®åŒæ­¥

#### ä¿®æ”¹å‰çš„é—®é¢˜
```typescript
// ç™»å½•åˆå¹¶è´­ç‰©è½¦åï¼Œæ²¡æœ‰è§¦å‘è´­ç‰©è½¦é‡æ–°åŠ è½½
if (mergeResponse.ok) {
  localStorage.removeItem('session_id');
  // ç¼ºå°‘è´­ç‰©è½¦é‡æ–°åŠ è½½é€»è¾‘
}
```

#### ä¿®å¤åçš„ä»£ç 
```typescript
// ç™»å½•åˆå¹¶è´­ç‰©è½¦åï¼Œè§¦å‘è´­ç‰©è½¦é‡æ–°åŠ è½½
if (mergeResponse.ok) {
  localStorage.removeItem('session_id');
  
  // è§¦å‘è´­ç‰©è½¦é‡æ–°åŠ è½½
  window.dispatchEvent(new StorageEvent('storage', {
    key: 'auth_token',
    newValue: data.tokens.accessToken,
    oldValue: null
  }));
}
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤1: é‡å¤æ·»åŠ é—®é¢˜
- **ä¿®å¤å‰**: å¿«é€Ÿç‚¹å‡»å¯èƒ½æ·»åŠ å¤šä¸ªç›¸åŒå•†å“
- **ä¿®å¤å**: ç›¸åŒå•†å“åªä¼šæ›´æ–°æ•°é‡ï¼Œä¸ä¼šé‡å¤æ·»åŠ 

### ä¿®å¤2: ç™»å½•åè´­ç‰©è½¦ä¸¢å¤±
- **ä¿®å¤å‰**: ç™»å½•åè´­ç‰©è½¦å†…å®¹ä¸¢å¤±
- **ä¿®å¤å**: ç™»å½•åæ­£ç¡®æ˜¾ç¤ºåˆå¹¶åçš„è´­ç‰©è½¦å†…å®¹

## æµ‹è¯•éªŒè¯

### åç«¯æµ‹è¯•
```bash
cd backend
export DB_CLIENT=sqlite3

# æµ‹è¯•é‡å¤æ·»åŠ 
node test-duplicate-add.js

# æµ‹è¯•ç™»å½•æµç¨‹
node test-logout-cart.js
```

### æµ‹è¯•ç»“æœ
```
ğŸ§ª Testing Duplicate Add Prevention...
âœ… Login successful
1. Adding item first time...
âœ… First add successful
âœ… Cart after first add: { itemCount: 1, items: 1 }
2. Adding same item again...
âœ… Second add successful
âœ… Cart after second add: { itemCount: 2, items: 1 }
âœ… Quantity correctly increased to 2
ğŸ‰ Duplicate add test completed!
```

## æŠ€æœ¯ç»†èŠ‚

### é˜²é‡å¤æœºåˆ¶
1. **å‰ç«¯æ£€æŸ¥**: åœ¨å‘é€è¯·æ±‚å‰æ£€æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
2. **æ•°é‡æ›´æ–°**: å·²å­˜åœ¨å•†å“ä½¿ç”¨`updateQuantity`è€Œä¸æ˜¯`addItem`
3. **çŠ¶æ€åŒæ­¥**: ç¡®ä¿å‰ç«¯çŠ¶æ€ä¸åç«¯æ•°æ®ä¸€è‡´

### ç™»å½•åŒæ­¥æœºåˆ¶
1. **åˆå¹¶è§¦å‘**: ç™»å½•æˆåŠŸåè‡ªåŠ¨è§¦å‘è´­ç‰©è½¦åˆå¹¶
2. **äº‹ä»¶é€šçŸ¥**: ä½¿ç”¨`StorageEvent`é€šçŸ¥è´­ç‰©è½¦ä¸Šä¸‹æ–‡
3. **é‡æ–°åŠ è½½**: åˆå¹¶åè‡ªåŠ¨é‡æ–°åŠ è½½ç”¨æˆ·è´­ç‰©è½¦æ•°æ®

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### é‡å¤æ·»åŠ é—®é¢˜
- **å³æ—¶åé¦ˆ**: ç”¨æˆ·ç‚¹å‡»åç«‹å³çœ‹åˆ°æ•°é‡æ›´æ–°
- **é˜²æ­¢è¯¯æ“ä½œ**: é¿å…æ„å¤–æ·»åŠ å¤šä¸ªç›¸åŒå•†å“
- **çŠ¶æ€ä¸€è‡´**: ç¡®ä¿æ˜¾ç¤ºçš„æ•°é‡ä¸å®é™…è´­ç‰©è½¦ä¸€è‡´

### ç™»å½•åŒæ­¥é—®é¢˜
- **æ— ç¼ä½“éªŒ**: ç™»å½•åè´­ç‰©è½¦å†…å®¹è‡ªåŠ¨åŒæ­¥
- **æ•°æ®ä¿æŒ**: æ¸¸å®¢è´­ç‰©è½¦å†…å®¹ä¸ä¼šä¸¢å¤±
- **æ™ºèƒ½åˆå¹¶**: è‡ªåŠ¨å¤„ç†é‡å¤å•†å“çš„æ•°é‡åˆå¹¶

## ç›¸å…³æ–‡ä»¶

- `frontend/src/contexts/CartContext.tsx` - è´­ç‰©è½¦ä¸Šä¸‹æ–‡ï¼ˆä¿®å¤é‡å¤æ·»åŠ ï¼‰
- `frontend/src/contexts/AuthContext.tsx` - è®¤è¯ä¸Šä¸‹æ–‡ï¼ˆä¿®å¤ç™»å½•åŒæ­¥ï¼‰
- `backend/test-duplicate-add.js` - é‡å¤æ·»åŠ æµ‹è¯•
- `backend/test-logout-cart.js` - ç™»å½•æµç¨‹æµ‹è¯•

## æ€»ç»“

é€šè¿‡æ”¹è¿›å‰ç«¯é€»è¾‘å’Œåç«¯åŒæ­¥æœºåˆ¶ï¼ŒæˆåŠŸè§£å†³äº†è´­ç‰©è½¦çš„ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

1. **é‡å¤æ·»åŠ é—®é¢˜**: é€šè¿‡å‰ç«¯æ£€æŸ¥å’Œåç«¯èšåˆï¼Œç¡®ä¿ç›¸åŒå•†å“åªæ›´æ–°æ•°é‡
2. **ç™»å½•åŒæ­¥é—®é¢˜**: é€šè¿‡äº‹ä»¶è§¦å‘å’ŒçŠ¶æ€é‡æ–°åŠ è½½ï¼Œç¡®ä¿ç™»å½•åè´­ç‰©è½¦æ•°æ®æ­£ç¡®æ˜¾ç¤º

è¿™äº›ä¿®å¤æ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒï¼Œç¡®ä¿è´­ç‰©è½¦åŠŸèƒ½çš„å¯é æ€§å’Œä¸€è‡´æ€§ã€‚ 