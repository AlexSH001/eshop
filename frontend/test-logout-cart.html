<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logout Cart Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 3px; }
        .cart-status { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 10px; 
            background: #007bff; 
            color: white; 
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="cart-status" id="cart-status">Cart: 0 items</div>
    
    <h1>üõí Logout Cart Test</h1>
    
    <div class="test-section">
        <h3>1. Login and Add Items</h3>
        <button onclick="loginAndAddItems()">Login & Add Items</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. Check Cart Status</h3>
        <button onclick="checkCartStatus()">Check Cart</button>
        <div id="cart-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. Logout Test</h3>
        <button onclick="testLogout()">Logout</button>
        <div id="logout-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. Post-Logout Cart Check</h3>
        <button onclick="checkPostLogoutCart()">Check Cart After Logout</button>
        <div id="post-logout-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. Add Items as Guest</h3>
        <button onclick="addGuestItems()">Add Guest Items</button>
        <div id="guest-result" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let sessionId = localStorage.getItem('session_id') || Math.random().toString(36).substr(2, 9);
        let authToken = localStorage.getItem('auth_token');

        // Initialize session ID
        if (!localStorage.getItem('session_id')) {
            localStorage.setItem('session_id', sessionId);
        }

        // Update cart status display
        function updateCartStatus() {
            const statusDiv = document.getElementById('cart-status');
            const token = localStorage.getItem('auth_token');
            const sessionId = localStorage.getItem('session_id');
            const type = token ? 'User' : 'Guest';
            statusDiv.textContent = `Cart (${type}): Loading...`;
        }

        // Listen for cart changes
        window.addEventListener('storage', (e) => {
            if (e.key === 'auth_token' || e.key === 'session_id') {
                updateCartStatus();
            }
        });

        async function loginAndAddItems() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = 'Logging in and adding items...';
            
            try {
                // Login
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'user@example.com',
                        password: 'password123'
                    })
                });

                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    authToken = loginData.tokens.accessToken;
                    localStorage.setItem('auth_token', authToken);
                    localStorage.setItem('user', JSON.stringify(loginData.user));
                    
                    // Add items to cart
                    const addResponse = await fetch(`${API_BASE}/cart/items`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`,
                        },
                        body: JSON.stringify({
                            productId: 45,
                            quantity: 2
                        })
                    });

                    if (addResponse.ok) {
                        resultDiv.innerHTML = `
                            <div class="success">
                                ‚úÖ Login successful and items added!<br>
                                User: ${loginData.user.first_name} ${loginData.user.last_name}<br>
                                Added 2 items to cart
                            </div>
                        `;
                        updateCartStatus();
                    } else {
                        resultDiv.innerHTML = `<div class="error">‚ùå Failed to add items</div>`;
                    }
                } else {
                    const error = await loginResponse.json();
                    resultDiv.innerHTML = `<div class="error">‚ùå Login failed: ${error.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function checkCartStatus() {
            const resultDiv = document.getElementById('cart-result');
            resultDiv.innerHTML = 'Checking cart...';
            
            try {
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                } else if (sessionId) {
                    headers['X-Session-ID'] = sessionId;
                }

                const cartResponse = await fetch(`${API_BASE}/cart`, { headers });

                if (cartResponse.ok) {
                    const cartData = await cartResponse.json();
                    const statusDiv = document.getElementById('cart-status');
                    const type = authToken ? 'User' : 'Guest';
                    statusDiv.textContent = `Cart (${type}): ${cartData.summary.itemCount} items`;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Cart status:<br>
                            Items: ${cartData.summary.itemCount}<br>
                            Total: $${cartData.summary.total}<br>
                            Type: ${authToken ? 'User Cart' : 'Guest Cart'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed to get cart</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testLogout() {
            const resultDiv = document.getElementById('logout-result');
            resultDiv.innerHTML = 'Logging out...';
            
            try {
                // Simulate logout
                localStorage.removeItem('user');
                localStorage.removeItem('auth_token');
                localStorage.removeItem('refresh_token');
                authToken = null;
                
                // Trigger logout event
                window.dispatchEvent(new CustomEvent('logout'));
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'auth_token',
                    newValue: null,
                    oldValue: 'previous-token'
                }));
                
                resultDiv.innerHTML = `
                    <div class="info">
                        ‚úÖ Logout completed!<br>
                        Auth token removed<br>
                        Cart should be cleared and reloaded
                    </div>
                `;
                updateCartStatus();
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function checkPostLogoutCart() {
            const resultDiv = document.getElementById('post-logout-result');
            resultDiv.innerHTML = 'Checking cart after logout...';
            
            try {
                const sessionId = localStorage.getItem('session_id');
                const headers = {};
                if (sessionId) {
                    headers['X-Session-ID'] = sessionId;
                }

                const cartResponse = await fetch(`${API_BASE}/cart`, { headers });

                if (cartResponse.ok) {
                    const cartData = await cartResponse.json();
                    const statusDiv = document.getElementById('cart-status');
                    statusDiv.textContent = `Cart (Guest): ${cartData.summary.itemCount} items`;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Post-logout cart status:<br>
                            Items: ${cartData.summary.itemCount}<br>
                            Total: $${cartData.summary.total}<br>
                            Type: Guest Cart<br>
                            Session ID: ${sessionId}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed to get cart</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function addGuestItems() {
            const resultDiv = document.getElementById('guest-result');
            resultDiv.innerHTML = 'Adding items as guest...';
            
            try {
                const sessionId = localStorage.getItem('session_id');
                
                const addResponse = await fetch(`${API_BASE}/cart/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': sessionId,
                    },
                    body: JSON.stringify({
                        productId: 46,
                        quantity: 1
                    })
                });

                if (addResponse.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Guest items added!<br>
                            Added 1 item to guest cart<br>
                            Session ID: ${sessionId}
                        </div>
                    `;
                    updateCartStatus();
                } else {
                    const error = await addResponse.json();
                    resultDiv.innerHTML = `<div class="error">‚ùå Failed: ${error.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Initialize
        updateCartStatus();
        checkCartStatus();
    </script>
</body>
</html> 